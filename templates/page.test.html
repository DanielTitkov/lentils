{{ define "title" }} {{ .Test.Code }} {{ end }}
{{ define "view" }}
<main>
  <div class="section">
    <h1 class="title is-1">{{ .Test.Title }}</h1>
    <h3 class="subtitle is-3">{{ .Test.Description }}</h3>
    {{ template "show-details-block" . }}
    {{ if eq .Test.Take.Status .QuestionsStatus }}
    {{ template "show-instruction-block" . }}
    {{ end }}
  </div>

  {{ if eq .Test.Take.Status .IntroStatus }}
  <div class="section">
    <div class="columns">
      <div class="column is-6">
        <p class="title is-5">Select language</p>
        {{ range .Test.AvailableLocales }}
        <button class="m-2 p-3 button is-outlined is-large {{ if eq . $.Locale }}is-success{{else}}{{ end }}"
          live-click="set-locale" live-value-locale="{{.}}" title="{{.}}">
          <p class="title is-3">{{ LocaleIcon . }}</p>
        </button>
        {{end}}
      </div>
      <div class="column is-6">
        <p class="title is-5">Interface settings</p>
        {{ template "test-controls-info" . }}
      </div>
    </div>
    <div class="notification box">
      <p class="title is-3">Instructions</p>
      <div class="content is-medium">
        {{ .Test.Instruction }}
      </div>
    </div>
  </div>
  <div class="section">
    <p class="block is-size-5 has-text-centered">When you are happy please continue to the next step.</p>
    <div class="level">
      <div class="level-item has-text-centered">
        <div class="block">
          <button class="button is-large is-primary is-rounded" live-click="begin-test">Continue</button>
        </div>
      </div>
    </div>
  </div>
  {{ end }}

  {{ if eq .Test.Take.Status .QuestionsStatus }}
  <div class="section">
    <div class="block">
      <progress class="progress is-normal is-success" value="{{ .Page }}" max="{{ .Test.PageCount }}">{{
        .Page }}%</progress>
      <p class="header">Page {{ .Page }} of {{ .Test.PageCount }}</p>
    </div>
    {{ range .CurrentQuestions }}
    <div class="notification box {{ if .IsDone }}question-done{{end}}">
      <p class="title is-5">{{ .Content }}</p>
      <div>
        {{ range $i, $item := .Items }}
        <p class="title is-3">{{ .Content }}</p>
        <div class="control">
          {{ range $j, $s := N .Steps }}
          <button class="button {{ if eq $item.CurrentResponseValue $j }}is-success{{ end }}"
            live-click="response-update" live-value-item="{{ $item.Code }}" live-value-val="{{ $j }}" {{ if eq (len
            $.CurrentQuestions) 1 }} live-window-keyup="response-update" live-key="{{ Plus1 $j }}" {{ end }}>
            {{ Plus1 $j }}
          </button>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
  <div class="level">
    <div class="level-item has-text-centered">
      <div class="block">
        <button class="button is-large is-rounded is-danger" live-click="prev-page" {{ if le .Page 1
          }}disabled{{end}}>Previous</button>
      </div>
    </div>
    <div class="level-item has-text-centered">
      <div class="block">
        {{ if ge .Page .Test.PageCount }}
        <button class="button is-large is-rounded is-success" live-click="end-test" {{ if .Test.IsNotDone
          }}disabled{{end}}>Finish</button>
        {{ else }}
        <button class="button is-large is-rounded is-success" live-click="next-page" {{ if ge .Page .Test.PageCount
          }}disabled{{end}} {{ if .Test.IsPageNotDone .Page }}disabled{{end}}>Next</button>
        {{ end }}
      </div>
    </div>
  </div>
  <div class="section">
    {{ template "test-controls-info" . }}
  </div>
  {{ end }}
  <!-- end questions status -->

  {{ if eq .Test.Take.Status .FinishStatus }}
  <div class="notification box">
    <table class="charts-css bar show-labels" id="basic-chart">
      <tbody>
        {{ range $i, $scale := .Test.Scales }}
        <tr>
          <th scope="row"> {{ $scale.Title }} </th>
          <td style="--size: calc({{ $scale.Result.Score }} / {{ $scale.Result.Max }} )">{{printf "%.1f" $scale.Result.Score }}</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
    <p>
      <a href="/result/{{ .Test.Take.ID }}">Result permanent link</a>
    </p>
  </div>
  <div class="columns is-multiline">
    {{ range $i, $scale := .Test.Scales }}
    <div class="column is-6">
      <div class="notification box">
        <div class="columns">
          <div class="column">
            <p class="title is-3">{{ $scale.Title }}</p>
            <p class="subtitle is-5">{{ $scale.Description }}</p>
          </div>
          <div class="column is-narrow">
            <p class="title is-3 has-text-primary">{{printf "%.1f" $scale.Result.Score }}</p>
          </div>
        </div>
        <p class="heading">{{ $scale.Result.Formula }}</p>
        <hr>
        <div class="level">
          <div class="level-left">
            <div class="level-item">{{ $scale.Result.Min }}</div>
          </div>
          <div class="level-item has-text-centered">{{ Mean $scale.Result.Min $scale.Result.Max }}</div>
          <div class="level-right">
            <div class="level-item">{{ $scale.Result.Max }}</div>
          </div>
        </div>
        <progress class="progress is-large is-success" value="{{ $scale.Result.Score }}"
          max="{{ Sum $scale.Result.Max $scale.Result.Min }}">
          {{ $scale.Result.Score }}
        </progress>
        <div class="content is-normal">
          {{ if $scale.Result.Interpretation }}
          {{ $scale.Result.Interpretation.Content }}
          {{ else }}
          <p>Interpretation not found. This problem is reported.</p>
          {{ end }}
        </div>
      </div>
    </div>
    {{ end }}
  </div>
  {{ end }}
</main>
{{ end }}

{{ define "test-controls-info" }}
<div class="notification has-background-grey-lighter">
  <div class="columns">
    <div class="column is-6">
      <p>Auto-Next: <b>{{ if .AutoNext }}ON{{else}}OFF{{end}}</b></p>
      <p class="heading">
        If Auto-Next is on, test will switch to the next page as soon as all the questions on a page are answered.
        Otherwise you would need to click "Next" button.
      </p>
      <p>
        <button class="button is-rounded {{ if .AutoNext }}is-success{{else}}is-outlined{{end}}"
          live-click="toggle-auto-next">
          Auto-Next
        </button>
      </p>
    </div>
    {{ if eq .Test.Display.QuestionsPerPage 1 }}
    <div class="column is-6">
      <p>
        You can use number keys (1, 2, etc.) on your keyboard to select response variants
        (works only if there's 1 questions per page).
      </p>
    </div>
    {{ end }}
  </div>
</div>
{{ end }}

{{ define "show-details-block" }}
<div class="block">
  <p class="is-clickable subtitle is-6 is-size-6-mobile has-text-grey" live-click="toggle-show-details">
    {{ if .ShowDetails }}
    Hide test details
    <i class="bi bi-caret-up-fill"></i>
    {{ else }}
    Show test details
    <i class="bi bi-caret-down-fill"></i>
    {{ end }}
  </p>
</div>
{{ if .ShowDetails }}
<div class="notification has-background-grey-lighter">
  {{ template "test-tags" .Test }}
  <div class="columns">
    <div class="column">
      <div class="content is-medium">
        {{ .Test.Details }}
      </div>
    </div>
    <div class="column is-narrow">
      <p><b>Scales:</b> {{ len .Test.Scales }}</p>
      <p><b>Questions:</b> {{ len .Test.Questions }}</p>
    </div>
  </div>
</div>
{{ end }}
{{ end }}

{{ define "show-instruction-block" }}
<div class="block">
  <p class="is-clickable subtitle is-6 is-size-6-mobile has-text-grey" live-click="toggle-show-instruction">
    {{ if .ShowInstruction }}
    Hide test instructions
    <i class="bi bi-caret-up-fill"></i>
    {{ else }}
    Show test instructions
    <i class="bi bi-caret-down-fill"></i>
    {{ end }}
  </p>
</div>
{{ if .ShowInstruction }}
<div class="notification has-background-grey-lighter">
  <p class="title is-3">Instructions</p>
  <div class="content is-medium">
    {{ .Test.Instruction }}
  </div>
</div>
{{ end }}
{{ end }}